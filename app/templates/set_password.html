<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
  <meta charset="UTF-8">
  <title>Rentus • Definir Senha</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 text-slate-200 min-h-screen flex items-center justify-center p-4">

  <div class="w-full max-w-lg bg-slate-800 border border-slate-700
              rounded-2xl shadow-xl p-8 space-y-6">

    <!-- LOGO E SAUDAÇÃO -->
    <div class="flex flex-col items-center gap-4 text-center">
      <img src="/static/images/logo.png" alt="Rentus" class="h-40">
      <h1 class="text-2xl font-bold text-emerald-500">Bem-vindo ao Rentus Booster!</h1>
      <p class="text-slate-400" id="user-name">
        Olá! Você foi convidado para fazer parte da nossa equipe.
      </p>
      <p class="text-sm text-slate-500">
        Para começar, defina uma senha segura para sua conta.
      </p>
    </div>

    <!-- FORM -->
    <form id="form-set-password" class="space-y-4">

      <div>
        <label class="text-sm text-slate-300 font-medium">Nova Senha</label>
        <input
          id="nova-senha"
          type="password"
          placeholder="Mínimo 8 caracteres"
          class="w-full mt-1 px-4 py-2 rounded-lg
                 bg-slate-900 border border-slate-700
                 focus:outline-none focus:ring-2 focus:ring-emerald-600"
        >
        <div class="mt-2 text-xs text-slate-400 space-y-1">
          <div id="req-length" class="flex items-center gap-2">
            <span class="w-4 h-4 rounded-full bg-slate-700"></span>
            Mínimo 8 caracteres
          </div>
          <div id="req-upper" class="flex items-center gap-2">
            <span class="w-4 h-4 rounded-full bg-slate-700"></span>
            Letra maiúscula
          </div>
          <div id="req-lower" class="flex items-center gap-2">
            <span class="w-4 h-4 rounded-full bg-slate-700"></span>
            Letra minúscula
          </div>
          <div id="req-number" class="flex items-center gap-2">
            <span class="w-4 h-4 rounded-full bg-slate-700"></span>
            Número
          </div>
          <div id="req-special" class="flex items-center gap-2">
            <span class="w-4 h-4 rounded-full bg-slate-700"></span>
            Caractere especial (@#$%&*!)
          </div>
        </div>
      </div>

      <div>
        <label class="text-sm text-slate-300 font-medium">Confirmar Senha</label>
        <input
          id="confirmar-senha"
          type="password"
          placeholder="Digite a senha novamente"
          class="w-full mt-1 px-4 py-2 rounded-lg
                 bg-slate-900 border border-slate-700
                 focus:outline-none focus:ring-2 focus:ring-emerald-600"
        >
      </div>

      <button
        type="submit"
        id="btn-submit"
        class="w-full bg-emerald-600 hover:bg-emerald-500
               text-white py-3 rounded-lg font-medium shadow transition
               disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Definir Senha e Continuar
      </button>

      <div
        id="erro"
        class="hidden text-red-400 text-sm p-3 bg-red-900/20 rounded-lg"
      ></div>

      <div
        id="loading"
        class="hidden text-center text-slate-400 text-sm"
      >
        <div class="inline-block animate-spin rounded-full h-5 w-5 border-2 border-slate-400 border-t-transparent"></div>
        <span class="ml-2">Processando...</span>
      </div>

    </form>

  </div>

<script>
// Extrair token da URL
const urlParams = new URLSearchParams(window.location.search);
const token = urlParams.get('token');

if (!token) {
  document.getElementById('erro').textContent = "Token inválido ou ausente.";
  document.getElementById('erro').classList.remove('hidden');
  document.getElementById('btn-submit').disabled = true;
}

// Validação de senha em tempo real
const novaSenha = document.getElementById('nova-senha');
const requirements = {
  length: /^.{8,}$/,
  upper: /[A-Z]/,
  lower: /[a-z]/,
  number: /[0-9]/,
  special: /[@#$%&*!]/
};

novaSenha.addEventListener('input', () => {
  const senha = novaSenha.value;
  
  // Verificar cada requisito
  ['length', 'upper', 'lower', 'number', 'special'].forEach(req => {
    const elem = document.getElementById(`req-${req}`).querySelector('span');
    if (requirements[req].test(senha)) {
      elem.classList.remove('bg-slate-700');
      elem.classList.add('bg-emerald-600');
    } else {
      elem.classList.remove('bg-emerald-600');
      elem.classList.add('bg-slate-700');
    }
  });
});

// Submit do formulário
document.getElementById('form-set-password').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const novaSenha = document.getElementById('nova-senha').value;
  const confirmarSenha = document.getElementById('confirmar-senha').value;
  const erro = document.getElementById('erro');
  const loading = document.getElementById('loading');
  const btnSubmit = document.getElementById('btn-submit');

  // Validações
  if (novaSenha !== confirmarSenha) {
    erro.textContent = "As senhas não conferem";
    erro.classList.remove('hidden');
    return;
  }

  // Verificar requisitos
  const allValid = Object.values(requirements).every(regex => regex.test(novaSenha));
  if (!allValid) {
    erro.textContent = "A senha não atende a todos os requisitos de segurança";
    erro.classList.remove('hidden');
    return;
  }

  // Esconder erros e mostrar loading
  erro.classList.add('hidden');
  loading.classList.remove('hidden');
  btnSubmit.disabled = true;

  try {
    const response = await fetch('/api/auth/set-password', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        token: token,
        nova_senha: novaSenha,
        confirmar_senha: confirmarSenha
      })
    });

    const data = await response.json();

    if (response.ok) {
      // Sucesso - redirecionar para login
      alert(data.message || "Senha definida com sucesso! Você já pode fazer login.");
      window.location.href = "/";
    } else {
      // Erro
      erro.textContent = data.detail || "Erro ao definir senha";
      erro.classList.remove('hidden');
    }
  } catch (error) {
    console.error("Erro:", error);
    erro.textContent = "Erro ao conectar com o servidor";
    erro.classList.remove('hidden');
  } finally {
    loading.classList.add('hidden');
    btnSubmit.disabled = false;
  }
});
</script>

</body>
</html>
