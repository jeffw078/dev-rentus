<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
  <meta charset="UTF-8" />
  <title>Rentus An√°lises</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Prevenir flash de conte√∫do (FOUC) - Esconder elementos protegidos inicialmente */
    [data-require-profile],
    [data-require-admin],
    [data-require-permission],
    [data-hide-for-profiles],
    [data-show-for-profiles] {
      display: none !important;
      visibility: hidden !important;
    }
    
    /* Depois que o JS verificar, adicionar classe .permissions-checked ao body */
    body.permissions-checked [data-require-profile],
    body.permissions-checked [data-require-admin],
    body.permissions-checked [data-require-permission],
    body.permissions-checked [data-hide-for-profiles],
    body.permissions-checked [data-show-for-profiles] {
      display: block !important;
      visibility: visible !important;
    }
    
    /* Sidebar overlay */
    #sideMenu {
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      width: 0;                           /* come√ßa fechado */
      background: #1e293b;                /* slate-800 */
      overflow-x: hidden;
      transition: width 0.25s ease-in-out;
      z-index: 9999;
      padding: 0;                         /* evita empurrar conte√∫do antes de abrir */
    }

    #sideMenu.open {
      width: 350px;                       /* menu aberto */
      padding: 24px;
    }

    /* Backdrop */
    #menuBackdrop {
      display: none;
      position: fixed;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.4);
      z-index: 9990;
    }

    /* Tooltip */
    .tooltip:hover::after {
      content: attr(data-tip);
      position: absolute;
      background: #000;
      color: #fff;
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 6px;
      top: 110%;
      left: 0;
      white-space: nowrap;
      z-index: 99999;
    }
  </style>
</head>

<body class="bg-slate-900 text-slate-200 min-h-screen flex flex-col">

  <!-- BACKDROP -->
  <div id="menuBackdrop" onclick="toggleMenu()"></div>

  <!-- HEADER -->
  <header class="w-full flex items-center justify-between gap-4 py-4 px-6 bg-slate-800 border-b border-slate-700 shadow-sm">

    <div class="flex items-center gap-4">
      <!-- Bot√£o do menu -->
      <button onclick="toggleMenu()" class="text-2xl select-none">‚ò∞</button>

      <!-- Logo √† esquerda -->
      <div class="flex items-center gap-3">
        <img src="/static/images/logo.png" alt="Rentus" class="h-10">
        <span class="text-xl font-bold">Rentus An√°lises</span>
      </div>
    </div>

    <!-- User menu -->
    <div class="flex items-center gap-3">
      <div class="text-right text-sm">
        <div class="text-slate-400">Ol√°,</div>
        <div class="font-medium" id="user-name">Usu√°rio</div>
      </div>
      <button onclick="window.location.href='/auth/profile'" 
              class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition">
        Perfil
      </button>
      <button onclick="logout()" 
              class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded-lg text-sm transition">
        Sair
      </button>
    </div>
  </header>

  <!-- MENU LATERAL -->
  <aside id="sideMenu">

    <button onclick="toggleMenu()" class="text-2xl mb-6">‚úï</button>

    <h2 class="text-lg font-bold mb-4">Ferramentas</h2>

    <!-- Bot√£o Ficha Presen√ßa -->
    <label class="tooltip cursor-pointer flex items-center gap-3 bg-slate-700 hover:bg-slate-600 px-4 py-3 rounded-lg transition relative mb-3"
           data-tip="Clique, selecione o arquivo e aguarde a convers√£o">
      <input type="file" id="fichaUpload" class="hidden" accept=".xlsx,.xls" onchange="enviarFichaPresenca()">
      üìÑ An√°lise de Ficha Presen√ßa
    </label>

    <!-- Gest√£o de Usu√°rios (apenas admin) -->
    <button id="btn-admin-users" style="display:none" 
            onclick="window.location.href='/admin/users'" 
            class="w-full flex items-center gap-3 bg-red-700 hover:bg-red-600 px-4 py-3 rounded-lg transition mb-3">
      üë§ Gest√£o de Usu√°rios
    </button>

    <!-- Mapa do Site -->
    <button onclick="window.location.href='/sitemap'" 
            class="w-full flex items-center gap-3 bg-blue-700 hover:bg-blue-600 px-4 py-3 rounded-lg transition mb-3">
      üó∫Ô∏è Mapa do Site
    </button>

    <!-- Teste de Acesso -->
    <button onclick="window.location.href='/teste-acesso'" 
            class="w-full flex items-center gap-3 bg-purple-700 hover:bg-purple-600 px-4 py-3 rounded-lg transition mb-3">
      üß™ Teste de Controle de Acesso
    </button>

    <div id="fichaStatus" class="mt-4 text-sm text-slate-300"></div>
  </aside>

  <!-- GRID DE M√ìDULOS (SEU LAYOUT ORIGINAL, SEM ALTERAR NADA) -->
  <main class="flex-1 p-8">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">

      <!-- EXEMPLO DO PRIMEIRO CARD ‚Äî OS OUTROS 15 EST√ÉO ABAIXO -->
       <button onclick="window.location.href='/modulo1';"
        class="module-card bg-slate-800 border border-slate-700 rounded-2xl shadow hover:shadow-lg
               transition-all px-5 py-6 text-left hover:bg-slate-700/50">
        <span class="text-sm text-sky-400 font-medium">M√ìDULO 1</span>
        <span class="text-lg font-semibold block mt-2">VR - VA - CESTA</span>
        <span class="text-sm text-slate-400 block mt-2">An√°lise completa de benef√≠cios</span>
      </button>

      <!-- M√ìDULO 2 ‚Äì Suprimentos  -->
      <button
  data-name="Suprimentos"
  onclick="window.location.href='/modulo2';"
  class="module-card bg-slate-800 border border-slate-700 rounded-2xl shadow hover:shadow-lg
         transition-all px-5 py-6 text-left flex flex-col justify-between hover:bg-slate-700/50"
>
  <span class="text-sm text-sky-400 font-medium mb-1">M√ìDULO 2</span>
  <span class="text-lg font-semibold">Suprimentos</span>
  <br>
  <span class="text-sm text-slate-400 mt-2">Suprimentos</span>
</button>


<!-- M√ìDULO 3 ‚Äì F√©rias Cheque -->
<button
  data-name="F√©rias Cheque"
  onclick="window.location.href='/modulo3';"
  class="module-card bg-slate-800 border border-slate-700 rounded-2xl shadow hover:shadow-lg
         transition-all px-5 py-6 text-left flex flex-col justify-between hover:bg-slate-700/50"
>
  <span class="text-sm text-sky-400 font-medium mb-1">M√ìDULO 3</span>
  <span class="text-lg font-semibold">F√©rias Cheque</span>
  <br>
  <span class="text-sm text-slate-400 mt-2">F√©rias Cheque</span>
</button>

<!-- M√ìDULO 4 ‚Äì Seguro de vida -->
<button
  data-name="Seguro de vida"
  onclick="window.location.href='/modulo4';"
  class="module-card bg-slate-800 border border-slate-700 rounded-2xl shadow hover:shadow-lg
         transition-all px-5 py-6 text-left flex flex-col justify-between hover:bg-slate-700/50"
>
  <span class="text-sm text-sky-400 font-medium mb-1">M√ìDULO 4</span>
  <span class="text-lg font-semibold">Seguro de vida</span>
  <br>
  <span class="text-sm text-slate-400 mt-2">Seguro de vida</span>
</button>

<!-- M√ìDULO 5 ‚Äì 13¬∫ sal√°rio -->
<button
  data-name="13¬∫ sal√°rio"
  onclick="window.location.href='/modulo5';"
  class="module-card bg-slate-800 border border-slate-700 rounded-2xl shadow hover:shadow-lg
         transition-all px-5 py-6 text-left flex flex-col justify-between hover:bg-slate-700/50"
>
  <span class="text-sm text-sky-400 font-medium mb-1">M√ìDULO 5</span>
  <span class="text-lg font-semibold">13¬∫ sal√°rio</span>
  <br>
  <span class="text-sm text-slate-400 mt-2">13¬∫ sal√°rio</span>
</button>

<!-- M√ìDULO 6 ‚Äì PLR -->
<button
  data-name="PLR"
  onclick="window.location.href='/modulo6';"
  class="module-card bg-slate-800 border border-slate-700 rounded-2xl shadow hover:shadow-lg
         transition-all px-5 py-6 text-left flex flex-col justify-between hover:bg-slate-700/50"
>
  <span class="text-sm text-sky-400 font-medium mb-1">M√ìDULO 6</span>
  <span class="text-lg font-semibold">PLR</span>
  <br>
  <span class="text-sm text-slate-400 mt-2">PLR</span>
</button>

<!-- M√ìDULO 7 ‚Äì Combust√≠vel -->
<button
  data-name="Combust√≠vel"
  onclick="window.location.href='/modulo7';"
  class="module-card bg-slate-800 border border-slate-700 rounded-2xl shadow hover:shadow-lg
         transition-all px-5 py-6 text-left flex flex-col justify-between hover:bg-slate-700/50"
>
  <span class="text-sm text-sky-400 font-medium mb-1">M√ìDULO 7</span>
  <span class="text-lg font-semibold">Combust√≠vel</span>
  <br>
  <span class="text-sm text-slate-400 mt-2">Combust√≠vel</span>
</button>

<!-- M√ìDULO 8 ‚Äì Bonifica√ß√£o -->
<button
  data-name="Bonifica√ß√£o"
  onclick="window.location.href='/modulo8';"
  class="module-card bg-slate-800 border border-slate-700 rounded-2xl shadow hover:shadow-lg
         transition-all px-5 py-6 text-left flex flex-col justify-between hover:bg-slate-700/50"
>
  <span class="text-sm text-sky-400 font-medium mb-1">M√ìDULO 8</span>
  <span class="text-lg font-semibold">Bonifica√ß√£o</span>
  <br>
  <span class="text-sm text-slate-400 mt-2">Bonifica√ß√£o</span>
</button>

<!-- M√ìDULO 9 ‚Äì Pr√™mio assiduidade -->
<button
  data-name="Pr√™mio assiduidade"
  onclick="window.location.href='/modulo9';"
  class="module-card bg-slate-800 border border-slate-700 rounded-2xl shadow hover:shadow-lg
         transition-all px-5 py-6 text-left flex flex-col justify-between hover:bg-slate-700/50"
>
  <span class="text-sm text-sky-400 font-medium mb-1">M√ìDULO 9</span>
  <span class="text-lg font-semibold">Pr√™mio assiduidade</span>
  <br>
  <span class="text-sm text-slate-400 mt-2">Pr√™mio assiduidade</span>
</button>

<!-- M√ìDULO 10 ‚Äì Uber -->
<button
  data-name="Uber"
  onclick="window.location.href='/modulo10';"
  class="module-card bg-slate-800 border border-slate-700 rounded-2xl shadow hover:shadow-lg
         transition-all px-5 py-6 text-left flex flex-col justify-between hover:bg-slate-700/50"
>
  <span class="text-sm text-sky-400 font-medium mb-1">M√ìDULO 10</span>
  <span class="text-lg font-semibold">Uber</span>
  <br>
  <span class="text-sm text-slate-400 mt-2">Uber</span>
</button>

<!-- M√ìDULO 11 ‚Äì Cadastro -->
<button
  data-name="Cadastro"
  onclick="window.location.href='/modulo11';"
  class="module-card bg-slate-800 border border-slate-700 rounded-2xl shadow hover:shadow-lg
         transition-all px-5 py-6 text-left flex flex-col justify-between hover:bg-slate-700/50"
>
  <span class="text-sm text-sky-400 font-medium mb-1">M√ìDULO 11</span>
  <span class="text-lg font-semibold">Cadastro</span>
  <br>
  <span class="text-sm text-slate-400 mt-2">Cadastro</span>
</button>

<!-- M√ìDULO 12 ‚Äì IAGF -->
<button
  data-name="IAGF"
  onclick="window.location.href='/modulo12';"
  class="module-card bg-slate-800 border border-slate-700 rounded-2xl shadow hover:shadow-lg
         transition-all px-5 py-6 text-left flex flex-col justify-between hover:bg-slate-700/50"
>
  <span class="text-sm text-sky-400 font-medium mb-1">M√ìDULO 12</span>
  <span class="text-lg font-semibold">IAGF</span>
  <br>
  <span class="text-sm text-slate-400 mt-2">IAGF</span>
</button>

<!-- M√ìDULO 13 ‚Äì GESP -->
<button
  data-name="GESP"
  onclick="window.location.href='/modulo13';"
  class="module-card bg-slate-800 border border-slate-700 rounded-2xl shadow hover:shadow-lg
         transition-all px-5 py-6 text-left flex flex-col justify-between hover:bg-slate-700/50"
>
  <span class="text-sm text-sky-400 font-medium mb-1">M√ìDULO 13</span>
  <span class="text-lg font-semibold">GESP</span>
  <br>
  <span class="text-sm text-slate-400 mt-2">GESP</span>
</button>

<!-- M√ìDULO 14 ‚Äì Faturamento -->
<button
  data-name="Faturamento"
  onclick="window.location.href='/modulo14';"
  class="module-card bg-slate-800 border border-slate-700 rounded-2xl shadow hover:shadow-lg
         transition-all px-5 py-6 text-left flex flex-col justify-between hover:bg-slate-700/50"
>
  <span class="text-sm text-sky-400 font-medium mb-1">M√ìDULO 14</span>
  <span class="text-lg font-semibold">Faturamento</span>
  <br>
  <span class="text-sm text-slate-400 mt-2">Faturamento</span>
</button>

<!-- M√ìDULO 15 ‚Äì Compras -->
<button
  data-name="Compras"
  onclick="window.location.href='/modulo15';"
  class="module-card bg-slate-800 border border-slate-700 rounded-2xl shadow hover:shadow-lg
         transition-all px-5 py-6 text-left flex flex-col justify-between hover:bg-slate-700/50"
>
  <span class="text-sm text-sky-400 font-medium mb-1">M√ìDULO 15</span>
  <span class="text-lg font-semibold">Compras</span>
  <br>
  <span class="text-sm text-slate-400 mt-2">Compras</span>
</button>

<!-- M√ìDULO 16 ‚Äì Horas suplementares -->
 <button
  data-name="Horas suplementares"
  onclick="window.location.href='/modulo16';"
  class="module-card bg-slate-800 border border-slate-700 rounded-2xl shadow hover:shadow-lg
         transition-all px-5 py-6 text-left flex flex-col justify-between hover:bg-slate-700/50"
>
  <span class="text-sm text-sky-400 font-medium mb-1">M√ìDULO 16</span>
  <span class="text-lg font-semibold">Horas suplementares</span>
  <br>
  <span class="text-sm text-slate-400 mt-2">Horas suplementares</span>
</button>

<!-- √ÅREA EXCLUSIVA - Renderiza√ß√£o condicional no servidor (sigilo absoluto) -->
{% set perfil_principal_lower = user.get('perfil_principal', '').lower() if user else '' %}
{% set perfis_lower = user.get('perfis', []) | map('lower') | list if user else [] %}
{% if user and (perfil_principal_lower == 'loyal' or 'loyal' in perfis_lower) %}
<button
  data-name="Recursos Avan√ßados"
  onclick="window.location.href='/premium';"
  class="module-card bg-slate-800 border border-slate-700 rounded-2xl shadow hover:shadow-lg
         transition-all px-5 py-6 text-left flex flex-col justify-between hover:bg-slate-700/50"
>
  <span class="text-sm text-yellow-400 font-medium mb-1">ACESSO ESPECIAL</span>
  <span class="text-lg font-semibold">‚≠ê Recursos Avan√ßados</span>
  <br>
  <span class="text-sm text-slate-400 mt-2">Conte√∫do Premium</span>
</button>
{% endif %}

    </div>
  </main>


  <!-- JS -->
  <script src="/static/permissions.js"></script>
  <script>
    // Verificar autentica√ß√£o
    const token = localStorage.getItem('access_token');
    if (!token) {
      window.location.href = '/';
    }

    // Carregar info do usu√°rio
    async function loadUserInfo() {
      try {
        const response = await fetch('/api/auth/me', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          throw new Error('Sess√£o expirada');
        }

        const user = await response.json();
        document.getElementById('user-name').textContent = user.nome_completo;

        // Mostrar bot√£o admin se for admin
        if (user.is_admin) {
          document.getElementById('btn-admin-users').style.display = 'flex';
        }
      } catch (error) {
        console.error('Erro ao carregar usu√°rio:', error);
        logout();
      }
    }

    function logout() {
      localStorage.removeItem('access_token');
      localStorage.removeItem('user');
      window.location.href = '/';
    }

    function toggleMenu() {
      const menu = document.getElementById("sideMenu");
      const backdrop = document.getElementById("menuBackdrop");

      menu.classList.toggle("open");

      if (menu.classList.contains("open")) {
        backdrop.style.display = "block";
      } else {
        backdrop.style.display = "none";
      }
    }

    // Carregar ao iniciar
    loadUserInfo();

    async function enviarFichaPresenca() {
      const status = document.getElementById("fichaStatus");
      const fileInput = document.getElementById("fichaUpload");

      if (!fileInput.files.length) return;

      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append("file", file);

      status.innerHTML = "‚è≥ Iniciando processamento...";

      const etapas = [
        "Lendo arquivo...",
        "Convertendo datas...",
        "Normalizando textos...",
        "Calculando indicadores...",
        "Gerando relat√≥rio final...",
        "Finalizando..."
      ];

      let i = 0;
      const interval = setInterval(() => {
        if (i < etapas.length) {
          status.innerHTML = `‚è≥ ${etapas[i]}`;
          i++;
        }
      }, 800);

      const response = await fetch("/ficha/processar", {
        method: "POST",
        body: formData
      });

      clearInterval(interval);

      const result = await response.json();

      if (result.success) {
        status.innerHTML = "‚úÖ Arquivo processado! Baixando...";
        window.location.href = result.download_url;
      } else {
        status.innerHTML = "‚ùå Erro: " + result.error;
      }
    }
  </script>

</body>
</html>
